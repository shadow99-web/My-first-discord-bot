const { SlashCommandBuilder, AttachmentBuilder } = require("discord.js");
const discordTranscripts = require("discord-html-transcripts");
const fs = require("fs-extra");
const axios = require("axios");
const FormData = require("form-data");
const path = require("path");

module.exports = {
  name: "transcriptchat",
  description: "Generates a chat transcript (HTML format) and uploads it to SHADOW Hosting.",
  usage: "/transcriptchat [#channel] [yes|no images]",

  data: new SlashCommandBuilder()
    .setName("transcriptchat")
    .setDescription("Generate an HTML transcript of this or another channel.")
    .addChannelOption(option =>
      option.setName("channel")
        .setDescription("The channel to generate transcript from")
        .setRequired(false)
    )
    .addStringOption(option =>
      option.setName("images")
        .setDescription("Include images? (yes/no)")
        .setRequired(false)
        .addChoices(
          { name: "Yes (Include Images)", value: "yes" },
          { name: "No (No Images)", value: "no" }
        )
    ),

  async execute(interaction, client) {
    try {
      const user = interaction.user;
      const channel = interaction.options.getChannel("channel") || interaction.channel;
      const includeImages = interaction.options.getString("images") || "yes";
      const withImages = includeImages === "yes";

      if (!channel.isTextBased()) {
        return interaction.reply({ content: "‚ùå That channel isn‚Äôt text-based!", ephemeral: true });
      }

      await interaction.reply("üïì Creating transcript... [‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 0%");
      const fileName = `${channel.name.replace(/[^a-zA-Z0-9]/g, "_")}_transcript.html`;
      const filePath = path.join(__dirname, "..", "transcripts", fileName);
      await fs.ensureDir(path.dirname(filePath));

      // Step 1: Create transcript
      const transcript = await discordTranscripts.createTranscript(channel, {
        limit: -1,
        returnType: "buffer",
        fileName,
        saveImages: withImages,
        footerText: `Generated by ${user.tag} on ${new Date().toLocaleString()}`,
        poweredBy: false,
      });

      await fs.writeFile(filePath, transcript);
      await interaction.editReply("üïì Creating transcript... [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë] 60%");

      // Step 2: Upload to your hosting server
      const form = new FormData();
      form.append("file", fs.createReadStream(filePath));

      const HOST = "http://us6.galactichosting.net:30028/upload"; // üåê your transcript host
      const res = await axios.post(HOST, form, {
        headers: form.getHeaders(),
        timeout: 60000,
        maxBodyLength: Infinity,
        maxContentLength: Infinity,
      });

      await interaction.editReply("üïì Creating transcript... [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] 100%");

      // Step 3: Return hosted URL
      if (res.data && res.data.fileUrl) {
        await interaction.editReply(`‚úÖ Transcript created!\nüìÇ [View Transcript](${res.data.fileUrl})`);
      } else {
        const attachment = new AttachmentBuilder(filePath, { name: fileName });
        await interaction.editReply({ content: "‚úÖ Transcript created (local file attached):", files: [attachment] });
      }

      // Step 4: Cleanup
      setTimeout(() => fs.unlink(filePath).catch(() => {}), 60000);

    } catch (error) {
      console.error("TranscriptChat Error:", error);
      await interaction.editReply("‚ùå Failed to create transcript. Please try again later.");
    }
  },
};
